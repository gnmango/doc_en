Let's create a component to initialize the inventory with the data loaded from DataStorage.
Let's use the SimpleInventory component, SimpleInventoryInitializedEvent and ItemStack to save and load the inventory data.

# Create ItemStack
1. Press **Workspace - MyDesk - Create Scripts - Create StructType** to create the **ItemStack**.
![ItemStack](https://mod-file.dn.nexoncdn.co.kr/bbs/1698114090988887824c2a5924ca6bb1a8653e5dab760.png "ItemStack")

2.  Add **SlotIndex, ItemId** and **Count** properties.
    ```lua
    Property:
    integer SlotIndex = 0
    string ItemId = ""
    integer Count = 0
    ```
    
3. Write a new ToTable() function. 

    ```lua
    Function:
    table ToTable()
    {
        return { SlotIndex = self.SlotIndex, ItemId = self.ItemId, Count = self.Count }
    }
    ```

4. Add the new FromTable() function and write as follows.

    ```lua
    void FromTable (table data)
    {
        self.SlotIndex = data.SlotIndex
        self.ItemId = data.ItemId
        self.Count = data.Count
    }
    ```

# Create SimpleInventoryInitializedEvent
1. Select **Workspace - MyDesk - Create Scripts - Create EventType** to create a new SimpleInventoryInitializedEvent. 

2. Add the **Meso** and **ItemStacks** properties to the event you created.

    ```lua
    Property:
    integer Meso = 0
    table ItemStacks = {}
    ```

# Creating SimpleInventory Component
1. In **Workspace - MyDesk - Create Scripts - Create Component**, create a new SimpleInventory component.
Add the SimpleInventory component to the <span style="color: #dc9656">**DefaultPlayer**</span>.
![simpleinventory](https://mod-file.dn.nexoncdn.co.kr/bbs/169862850366621dfa2f5ce5246e7bb3f80d634c199c3.png "simpleinventory")
2. Add the **Meso** and **ItemStacks** properties.
    
    ```lua
    Property:
    [None]
    integer Meso = 10000
    [None]
    table ItemStacks = {}
    ```

3. Add a OnBeginPlay() function. Initialize the inventory and write as follows to save and load data.
    * Initialize the inventory with the data retrieved from DataStorage.
    * If there is no data, reset to the default value.
    * Store and retrieve data using the JsonEncode(), JsonDecode() functions of HttpService.

    ```lua
    [server only]
    void OnBeginPlay()
    {
        -- Loading inventory data from data storage
        local userId = self.Entity.PlayerComponent.UserId
        local userDataStorage = _DataStorageService:GetUserDataStorage(userId)
        local errorCode, loadData = userDataStorage:GetAndWait("SimpleInventoryData")
        
        -- Output error code if data load fails
        if errorCode ~= 0 then
        	log_error("[SimpleInventory] Data load fails:" .. tostring(errorCode))
        	return
        end              
    }
    ```

4. Create the Deserialize() function and add the string-type parameter **dataString**. Write the following to convert the Json-formatted string to a table so that we can read the Meso and item data.

    ```lua
    void Deserialize (string dataString)
    {         
        if dataString == nil or dataString == "" then
        	return
        end
        
        local dataTable = _HttpService:JSONDecode(dataString)
        local meso = dataTable.Meso
        local stacks = dataTable.ItemStacks
        
        self.Meso = math.tointeger(meso)
        
        if stacks ~= nil then
        	for _, stackData in pairs(stacks) do
        		local stack = ItemStack()
        		stack:FromTable(stackData)
        		self.ItemStacks[stack.SlotIndex] = stack
        	end
        end
    }
    ```

5. In the OnBeginPlay() function, write the following at the bottom to call the Deserialized() function.

    ```lua
        -- If there is loaded data, apply it
        if loadData ~= nil then
        	self:Deserialize(loadData)
        end
    ```

6. Add a SendInitializedEvent() function. 

    ```lua
    [server only]
    void SendInitializedEvent ()
    {
        local event = SimpleInventoryInitializedEvent()
        event.Meso = self.Meso
        event.ItemStacks = self.ItemStacks
        self.Entity:SendEvent(event)
    }
    ```

7. Create the SendInitializedEventToClient() function in the SimpleInventory component. Add the **event** parameter. For the parameter type, select **EventType - SimpleInventoryInitializedEvent**.

    ```lua
    [client]
    void SendInitializedEventToClient (SimpleInventoryInitializedEvent event)
    {
        self.Meso = event.Meso
        self.ItemStacks = event.ItemStacks
        self.Entity:SendEvent(event)
    }
    ```
    
8. At the bottom of the SendInitializedEvent() function, add a function call to deliver the event to the local players only.

    ```lua
        -- Deliver to local players only
        self:SendInitializedEventToClient(event, self.Entity.PlayerComponent.UserId)
    ```

9. In the OnBeginPlay() function, under the paragraph 'If there is loaded data, apply it,' write the code as follows.
Call the `SendInitializedEvent()` function so that the inventory initialization event occurs if the data load fails.

    ```lua
    -- Inventory initialization event occurs
    self:SendInitializedEvent()
    ```

10. Add the `UserLeaveEvent` to the Event Handler. Write to save the inventory information when the player leaves the World.

    ```lua
    Event Handler
    [service: UserService]
    HandleUserLeaveEvent (UserLeaveEvent event)
    {
        --------------- Native Event Sender Info ----------------
        -- Sender: UserService
        -- Space: Server
        ---------------------------------------------------------
        
        -- Parameters
        local UserId = event.UserId
        ---------------------------------------------------------
        
        local thisUserId = self.Entity.PlayerComponent.UserId
        
        if thisUserId ~= UserId then
        	return
        end
        
        -- Save inventory data info when play is over
        local userDataStorage = _DataStorageService:GetUserDataStorage(thisUserId)
        if userDataStorage ~= nil then
        	local saveData = self:Serialize()
        	userDataStorage:SetAndWait("SimpleInventoryData", saveData)
        end
    }
    ```

11. Add the new string-type Serialize() function. Write the following so that the meso and item data can be saved in DataStorage. Put the Meso and items in one table and convert it to Json format.
    ```lua
    string Serialize ()
    {       
        local dataTable = {}
        local itemStacks = {}
        
        dataTable.Meso = self.Meso
        
        for _, stack in pairs(self.ItemStacks) do
        	local stackData = stack:ToTable()
        	table.insert(itemStacks, stackData)
        end
        
        if #itemStacks > 0 then
        	dataTable.ItemStacks = itemStacks
        end
        
        return _HttpService:JSONEncode(dataTable)
    }
    ```

12. Write the following at the bottom of the OnBeginPlay() function to save the data automatically at regular intervals.

    ```lua
        -- Automatically save data at regular intervals
        local saveInventory = function()
        local saveData = self:Serialize()
        userDataStorage:SetAsync("SimpleInventoryData", saveData, function() log ("[SimpleInventory] Saved") end)
        	log ("[SimpleInventory] Saving...")
        end
        
        local saveInterval = 300
        _TimerService:SetTimerRepeat(saveInventory, saveInterval, saveInterval)
    ```

# Full Script
#### SimpleInventory

```lua
Property:
[None]
integer Meso = 10000
[None]
table ItemStacks = {}

Method:
[server only]
void OnBeginPlay()
{  
    -- Loading inventory data from the data storage
    local userId = self.Entity.PlayerComponent.UserId
    local userDataStorage = _DataStorageService:GetUserDataStorage(userId)
    local errorCode, loadData = userDataStorage:GetAndWait("SimpleInventoryData")
    
    -- Output error code if data load fails
    if errorCode ~= 0 then
    	log_error("[SimpleInventory] Data load fails:" .. tostring(errorCode))
    	return
    end
    
    -- If there is loaded data, apply it
    if loadData ~= nil then
    	self:Deserialize(loadData)
    end
    
    -- Inventory initialization event occurs
    self:SendInitializedEvent()
    
    -- Automatically save at regular intervals
    local saveInventory = function()
    local saveData = self:Serialize()
    userDataStorage:SetAsync("SimpleInventoryData", saveData, function() log ("[SimpleInventory] Saved") end)
    	log ("[SimpleInventory] Saving...")
    end
    
    local saveInterval = 300
    _TimerService:SetTimerRepeat(saveInventory, saveInterval, saveInterval)
}
    
string Serialize()
{
    local dataTable = {}
    local itemStacks = {}
    
    dataTable.Meso = self.Meso
    
    for _, stack in pairs(self.ItemStacks) do
    	local stackData = stack:ToTable()
    	table.insert(itemStacks, stackData)
    end
    
    if #itemStacks > 0 then
    	dataTable.ItemStacks = itemStacks
    end
    
    return _HttpService:JSONEncode(dataTable)
}

void Deserialize (string dataString)
{
    if dataString == nil or dataString == "" then
    	return
    end
    
    local dataTable = _HttpService:JSONDecode(dataString)
    local meso = dataTable.Meso
    local stacks = dataTable.ItemStacks
    
    self.Meso = math.tointeger(meso)
    
    if stacks ~= nil then
    	for _, stackData in pairs(stacks) do
    		local stack = ItemStack()
    		stack:FromTable(stackData)
    		self.ItemStacks[stack.SlotIndex] = stack
    	end
    end
}

[server only]
void SendInitializedEvent()
{
    local event = SimpleInventoryInitializedEvent()
    event.Meso = self.Meso
    event.ItemStacks = self.ItemStacks
    self.Entity:SendEvent(event)
    
    -- Deliver to local players only
    self:SendInitializedEventToClient(event, self.Entity.PlayerComponent.UserId)
}

[client]
void SendInitializedEventToClient (SimpleInventoryInitializedEvent event)
{
    self.Meso = event.Meso
    self.ItemStacks = event.ItemStacks
    self.Entity:SendEvent(event)
}

Event Handler:
[service: UserService]
HandleUserLeaveEvent (UserLeaveEvent event)
{
    --------------- Native Event Sender Info ----------------
    -- Sender: UserService
    -- Space: Server
    ---------------------------------------------------------
    
    -- Parameters
    local UserId = event.UserId
    ---------------------------------------------------------
    
    local thisUserId = self.Entity.PlayerComponent.UserId
    
    if thisUserId ~= UserId then
    	return
    end
    
    -- Save inventory data info when play is over
    local userDataStorage = _DataStorageService:GetUserDataStorage(thisUserId)
    if userDataStorage ~= nil then
    	local saveData = self:Serialize()
    	userDataStorage:SetAndWait("SimpleInventoryData", saveData)
    end
}
```